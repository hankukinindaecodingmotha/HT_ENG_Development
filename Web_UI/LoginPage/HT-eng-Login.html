<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>로그인 - HTeng</title>
  <link rel="stylesheet" href="HT-eng-LoginStyle.css">
  <link rel="stylesheet" href="../Components/Header/HT_eng-header.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      padding-top: 120px
    }
  </style>
</head>

<body>
  <div id="header-container"></div>

  <div class="login-container">
    <div class="login-box">
      <div class="login-header">
        <h1>로그인</h1>
        <p>HT_ENG 계정으로 로그인하세요</p>
      </div>

      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="username">아이디</label>
          <input type="text" id="username" name="username" required placeholder="아이디를 입력하세요">
        </div>

        <div class="form-group">
          <label for="password">비밀번호</label>
          <input type="password" id="password" name="password" required placeholder="비밀번호를 입력하세요">
        </div>

        <button type="submit" class="login-btn">
          <i class="fas fa-sign-in-alt"></i>
          로그인
        </button>
      </form>

      <div class="login-footer">
        <p>계정이 없으신가요? <a href="/Web_UI/Signup/HT_eng-signup.html" class="signup-link">회원가입</a></p>
        <div class="demo-accounts">
          <h3>데모 계정</h3>
          <div class="demo-account">
            <strong>관리자:</strong> admin / admin1234
          </div>
          <div class="demo-account">
            <strong>활성 사용자:</strong> user1 / user1234
          </div>
          <div class="demo-account">
            <strong>승인 대기:</strong> user4 / user1234
          </div>
          <div class="demo-account">
            <strong>비활성 사용자:</strong> user7 / user1234
          </div>
          <div class="demo-account">
            <strong>전체 사용자:</strong> user1~user10 / user1234
          </div>
        </div>
      </div>
    </div>
  </div>

  <script defer src="../Components/Header/HT_eng-header.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const loginForm = document.getElementById('loginForm');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');

      // 폼 제출 이벤트
      loginForm.addEventListener('submit', handleLogin);

      // Enter 키 이벤트 리스너
      usernameInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          passwordInput.focus();
        }
      });

      passwordInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          handleLogin(e);
        }
      });

      async function handleLogin(e) {
        e.preventDefault();

        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
          alert('아이디와 비밀번호를 모두 입력해주세요.');
          return;
        }

        // 로딩 상태 표시
        const loginBtn = document.querySelector('.login-btn');
        const originalText = loginBtn.innerHTML;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 로그인 중...';
        loginBtn.disabled = true;

        try {
          console.log('로그인 시도:', { username, password: '***' });

          const response = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password })
          });

          console.log('서버 응답 상태:', response.status);
          console.log('서버 응답 헤더:', response.headers);

          const data = await response.json();
          console.log('서버 응답 데이터:', data);

          if (response.ok) {
            // 로그인 성공
            // 표준 키로 저장
            sessionStorage.setItem('auth_token', data.token);
            sessionStorage.setItem('auth_user', data.username);
            sessionStorage.setItem('auth_role', data.role);
            // 레거시 키도 병행 저장(혹시 다른 코드가 참조할 수 있으므로)
            sessionStorage.setItem('token', data.token);
            sessionStorage.setItem('username', data.username);
            sessionStorage.setItem('role', data.role);

            alert(`환영합니다, ${data.username}님!`);

            // 역할에 따라 리다이렉트
            if (data.role === 'admin') {
              window.location.href = '/Web_UI/Admin/HT_eng-Admin.html';
            } else {
              window.location.href = '/Web_UI/User/HT_eng-Profile.html';
            }
          } else {
            // 로그인 실패
            alert(data.message || '로그인에 실패했습니다.');
          }
        } catch (error) {
          console.error('Login error:', error);

          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            alert('서버에 연결할 수 없습니다. 서버가 실행 중인지 확인해주세요.\n\n서버 실행 방법:\n1. 터미널에서 Server 폴더로 이동\n2. "node server.js" 명령어 실행');
          } else if (error.name === 'TypeError' && error.message.includes('CORS')) {
            alert('CORS 오류가 발생했습니다. 서버 설정을 확인해주세요.');
          } else {
            alert(`로그인 중 오류가 발생했습니다: ${error.message}`);
          }
        } finally {
          // 로딩 상태 해제
          loginBtn.innerHTML = originalText;
          loginBtn.disabled = false;
        }
      }

      // 서버 연결 상태 확인
      async function checkServerStatus() {
        try {
          const response = await fetch('http://localhost:3000/api/products');
          if (response.ok) {
            console.log('서버 연결 상태: 정상');
            return true;
          }
        } catch (error) {
          console.log('서버 연결 상태: 연결 불가');
          return false;
        }
        return false;
      }

      // 페이지 로드 시 서버 상태 확인
      checkServerStatus();
    });
  </script>
</body>

</html>